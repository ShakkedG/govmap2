<html xmlns="http://www.w3.org/1999/xhtml"> 
<head> 
    <meta charset="utf-8" />
    <script src="https://www.govmap.gov.il/govmap/api/govmap.api.js" defer onload="initGovMap()"></script> 

    <script type="text/javascript"> 
    function initGovMap() { 
        govmap.createMap('map', { 
            token: 'ede9a5fd-7c23-432f-8ffb-d85feffa3f3c', 
            layers: ["GASSTATIONS","PARCEL_HOKS", "KSHTANN_ASSETS", "bus_stops", "PARCEL_ALL","219111","219113","219114"], 
            showXY: true, 
            identifyOnClick: true, 
            isEmbeddedToggle: false, 
            background: 2, 
            layersMode: 1, 
            zoomButtons: false, 
            level: 9,
            extent:{xmin: 193700, ymin: 664900, xmax: 195000, ymax: 666100}
        }); 
    } 

    function toggleButton() {
        const btn = document.getElementById('showButton');
        const resultsDiv = document.getElementById('results');

        if (!btn.classList.contains('redButton')) {
            btn.classList.add('redButton');

            var params = { 
                continous: false,
                drawType: govmap.drawType.Rectangle,
                filterLayer: false,
                isZoomToExtent: true,
                layers: ["GASSTATIONS", "219111", "219113", "219114"],
                returnFields: {
                    "GASSTATIONS": ["objectid", "company"],
                    "219111": ["value0"],
                    "219113": ["value0"],
                    "219114": ["value0"]
                }
            };

            govmap.selectFeaturesOnMap(params).then(function(response1) { 
                btn.classList.remove('redButton');
                resultsDiv.style.display = 'block';

                console.log('selectFeaturesOnMap response:', response1); 
                
                var html = '<div id="closeResultsBtn" onclick="closeResults()">âœ–</div>';

                if (response1 && response1.length > 0) { 
                    // ×©××•×ª ×™×¤×™× ×œ×©×›×‘×•×ª
                    const layerNames = {
                        "GASSTATIONS": "×ª×—× ×•×ª ×“×œ×§",
                        "219111": "× ×§×•×“×•×ª ×‘×¢×™× ×ª",
                        "219113": "××–×•×¨×™× ×‘×¢×™× ×ª",
                        "219114": "×›×‘×™×©×™× ×‘×¢×™× ×ª"
                    };

                    // ×¡×™×“×•×¨ ×”×ª×•×¦××•×ª ×œ×¤×™ ×©×›×‘×•×ª ×œ×¤×™ ×”×¡×“×¨ ×©×œ params.layers
                    const layersData = {};
                    params.layers.forEach(function(layerId, idx) {
                        const arr = Array.isArray(response1[idx]) ? response1[idx] : [];
                        layersData[layerId] = arr;
                    });

                    // ×¡×”×´×› ××•×‘×™×™×§×˜×™× ×‘×›×œ ×”×©×›×‘×•×ª ×™×—×“
                    const totalCount = Object.values(layersData)
                        .reduce((sum, arr) => sum + arr.length, 0);

                    html += '<h3>×ª×•×¦××•×ª ×—×™×¤×•×©:</h3>'; 
                    html += '<p>× ××¦××• ' + totalCount + ' ××•×‘×™×™×§×˜×™× ×‘××–×•×¨ ×©× ×‘×—×¨</p>'; 
                    html += '<div style="margin-top: 15px;">';
                    
                    // ×›×¨×˜×™×¡×™× ×™×¤×™× ×œ×ª×—× ×•×ª ×“×œ×§ (×× ×§×™×™××•×ª)
                    const gasStations = layersData["GASSTATIONS"] || [];
                    gasStations.forEach(function(station, index) {
                        html += '<div style="background: #f0f0f0; padding: 12px; margin: 8px 0; border-radius: 5px; border-left: 4px solid #4CAF50;">';
                        html += '<strong>×ª×—× ×ª ×“×œ×§ #' + (index + 1) + '</strong><br>';
                        if (station.company) {
                            html += '<span style="color: #333;">×—×‘×¨×”: </span><strong>' + station.company + '</strong><br>';
                        }
                        if (station.objectid) {
                            html += '<span style="color: #666;">××–×”×”: ' + station.objectid + '</span>';
                        }
                        html += '</div>';
                    });
                    
                    html += '</div>';
                    html += '<hr style="margin: 20px 0;">';

                    // ----- × ×ª×•× ×™× ×’×•×œ××™×™× ××¡×•×“×¨×™× ×œ×¤×™ ×©×›×‘×•×ª -----
                    html += '<h4 style="color: #667eea;">× ×ª×•× ×™× ×’×•×œ××™×™× ×œ×¤×™ ×©×›×‘×”</h4>';

                    params.layers.forEach(function(layerId) {
                        const items = layersData[layerId] || [];
                        if (!items.length) return; // ×œ×“×œ×’ ×¢×œ ×©×›×‘×•×ª ×¨×™×§×•×ª

                        const displayName = layerNames[layerId] || layerId;

                        html += '<h5 style="margin: 10px 0 5px; color:#333;">' + displayName + '</h5>';
                        html += '<ul style="margin-top: 0; padding-right: 20px;">';

                        items.forEach(function(feat, i) {
                            let label = "";

                            if (feat.company) {
                                label = feat.company;                // ×ª×—× ×•×ª ×“×œ×§
                            } else if (feat.value0 != null && feat.value0 !== "") {
                                label = feat.value0;                 // ×˜×§×¡×˜ ××”×©×“×•×ª ×©×œ 219xxx
                            } else {
                                label = "[×œ×œ× × ×ª×•× ×™×]";             // fallback
                            }

                            html += '<li>' + (i + 1) + '. ' + label + '</li>';
                        });

                        html += '</ul>';
                    });

                    // JSON ××œ× â€“ ×¨×§ ×œ××™ ×©×¨×•×¦×” ×œ×¨××•×ª ×”×›×•×œ
                    html += '<details style="margin-top: 12px;">';
                    html += '  <summary style="cursor:pointer; color:#667eea; font-weight:bold;">×”×¦×’ JSON ××œ×</summary>';
                    html += '  <pre style="background: #f5f5f5; padding: 10px; border-radius: 5px; overflow-x: auto;">' +
                                 JSON.stringify(response1, null, 2) +
                             '</pre>';
                    html += '</details>';
                    
                    resultsDiv.innerHTML = html; 
                    
                } else { 
                    html += '<p style="color: #f44336;">âŒ ×œ× × ××¦××• × ×§×•×“×•×ª ×¢× ×™×™×Ÿ ×‘××–×•×¨ ×©× ×‘×—×¨.</p>'; 
                    resultsDiv.innerHTML = html;
                } 
                
            }).catch(function(error) { 
                console.error('Error in selectFeaturesOnMap:', error); 
                btn.classList.remove('redButton');
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = '<div id="closeResultsBtn" onclick="closeResults()">âœ–</div><p style="color: red;">âŒ ×©×’×™××”: ' + (error.message || error) + '</p>'; 
            }); 

        } else {
            btn.classList.remove('redButton');
        }
    }

    function closeResults() {
        document.getElementById('results').style.display = 'none';
    }
    </script> 

    <style> 
    body { 
        margin: 0; 
        padding: 0; 
        font-family: Arial, sans-serif; 
    } 

    #header { 
        position: absolute; 
        top: 0; 
        left: 0; 
        right: 0; 
        height: 80px; 
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
        color: white; 
        display: flex; 
        align-items: center; 
        justify-content: space-between; 
        padding: 0 30px; 
        box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        z-index: 1001; 
    } 

    #header h1 { 
        margin: 0; 
        font-size: 32px; 
        font-weight: bold; 
    } 

    #map-container { 
        position: relative; 
        width: 100vw; 
        height: 100vh; 
        padding-top: 80px; 
        box-sizing: border-box; 
    } 

    #map { 
        width: 100%; 
        height: 100%; 
    } 

    #button-container { 
        position: absolute; 
        top: 100px; 
        left: 20px; 
        z-index: 1000; 
    } 

    #showButton { 
        padding: 15px 30px; 
        font-size: 18px; 
        background-color: #4CAF50; 
        color: white; 
        border: none; 
        border-radius: 5px; 
        cursor: pointer; 
        box-shadow: 0 4px 6px rgba(0,0,0,0.3); 
        transition: all 0.3s ease;
    } 

    #showButton:hover { 
        background-color: #45a049; 
        transform: translateY(-2px);
        box-shadow: 0 6px 8px rgba(0,0,0,0.4);
    } 

    .redButton {
        background-color: #f44336 !important;
    }

    .redButton:hover {
        background-color: #da190b !important;
    }

    #results { 
        position: absolute; 
        bottom: 20px; 
        left: 20px; 
        right: 20px; 
        max-height: 50vh; 
        overflow: auto; 
        background: white; 
        padding: 20px; 
        border-radius: 8px; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.3); 
        z-index: 1000; 
        display: none; 
    } 

    #closeResultsBtn {
        position: absolute;
        top: 8px;
        right: 12px;
        font-size: 22px;
        cursor: pointer;
        color: #444;
        font-weight: bold;
    }

    #closeResultsBtn:hover {
        color: #ff4444;
    }

    #results h3 {
        margin-top: 0;
        color: #667eea;
        border-bottom: 2px solid #667eea;
        padding-bottom: 10px;
    }

    #results pre { 
        background: #f5f5f5; 
        padding: 10px; 
        border-radius: 5px; 
        overflow-x: auto; 
    } 
    </style> 
</head> 

<body> 
    <div id="header"> 
        <h1>×©×§×“ ×’×•×œ×Ÿ GovMap</h1> 
        <div style="font-size: 18px;">××ª×¨ ×§×™×‘×•×¥ ×¢×™× ×ª</div> 
    </div> 

    <div id="map-container"> 
        <div id="button-container"> 
            <button id="showButton" onClick="toggleButton()">ğŸ—ºï¸ ×‘×—×¨ ××–×•×¨ ×‘××¤×”</button> 
        </div> 
        
        <div id="map"></div> 
        <div id="results"></div> 
    </div> 
</body> 
</html>
